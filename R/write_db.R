#' Write data to the database. Optionally update metadata tables in the process
#'
#' @param con A database connection
#' @param name Name of the table to write to
#' @param dta A data frame or sf data frame
#' @param overwrite If \code{TRUE}, overwrite an existing table
#' @param append If \code{TRUE}, append to an existing table
#' @param spatial If \code{TRUE}, write as spatial data
#' @param field_meta An optional data frame matching the structure for field metadata generated by \code{create_metadata_tables()}
#' @param table_meta An optional data frame matching the structure for table metadata generated by \code{create_metadata_tables()}
#' @param source_meta An optional data frame matching the structure for source metadata generated by \code{create_metadata_tables()}
#'
#' @export
#'
#' @importFrom sf st_write
#' @importFrom DBI dbWriteTable
#'

write_db <- function(con, name, dta, overwrite = FALSE, append = FALSE, spatial = FALSE, field_meta = NULL, table_meta = NULL, source_meta = NULL){

  if (spatial & 'sf' %in% class(dta)){
    sf::st_write(dta, con, name, delete_dsn = overwrite, append = append)
  } else {
    stop('`spatial` is TRUE, but `dta` is not of class sf', call. = FALSE)
  }

  if (!spatial){
    DBI::dbWriteTable(con, name, dta, overwrite = overwrite, append = append)
  }

  if (!is.null(field_meta)){

    if (is.null(table_meta)){
      stop("Both field and table metadata are required to update metadata")
    }

    update_metadata(con, field_meta, table_meta, source_meta)

  }

  return(invisible(name))

}
